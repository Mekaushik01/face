<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .redirect-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .redirect-text {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .redirect-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .manual-link {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .manual-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tracking-notice {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 20px;
            line-height: 1.4;
        }

        .error-container {
            display: none;
            background: rgba(255, 87, 87, 0.1);
            border: 1px solid rgba(255, 87, 87, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="redirect-container">
        <div class="spinner"></div>
        <div class="redirect-text">Please wait while we redirect you...</div>
        <div class="redirect-info">Preparing your destination</div>
        
        <div id="manual-redirect" style="display: none;">
            <p>If you're not redirected automatically:</p>
            <a href="#" id="manual-link" class="manual-link">Click here to continue</a>
        </div>

        <div id="error-container" class="error-container">
            <div class="error-title">Oops! Something went wrong</div>
            <div id="error-message">Invalid or expired tracking link.</div>
        </div>

        <div class="tracking-notice">
            ðŸ”’ Your privacy is important to us. We only collect anonymous analytics data to improve our services.
        </div>
    </div>

    <script>
        class TrackingRedirect {
            constructor() {
                this.urlParams = new URLSearchParams(window.location.search);
                this.trackingId = this.urlParams.get('t');
                this.redirectUrl = this.urlParams.get('redirect');
                this.visitorData = null;
                this.init();
            }

            async init() {
                try {
                    // Validate parameters
                    if (!this.trackingId || !this.redirectUrl) {
                        throw new Error('Missing required parameters');
                    }

                    // Validate redirect URL
                    try {
                        new URL(decodeURIComponent(this.redirectUrl));
                    } catch {
                        throw new Error('Invalid redirect URL');
                    }

                    // Collect visitor data
                    await this.collectVisitorData();
                    
                    // Send tracking data
                    await this.sendTrackingData();
                    
                    // Perform redirect
                    this.performRedirect();
                    
                } catch (error) {
                    console.error('Tracking error:', error);
                    this.showError(error.message);
                }
            }

            async collectVisitorData() {
                const browserInfo = this.getBrowserInfo();
                const locationInfo = await this.getLocationInfo();
                
                this.visitorData = {
                    trackingId: this.trackingId,
                    timestamp: Date.now(),
                    ip: locationInfo.ip,
                    city: locationInfo.city,
                    region: locationInfo.region,
                    country: locationInfo.country,
                    countryCode: locationInfo.countryCode,
                    latitude: locationInfo.latitude,
                    longitude: locationInfo.longitude,
                    timezone: locationInfo.timezone,
                    isp: locationInfo.isp,
                    language: navigator.language || 'Unknown',
                    languages: navigator.languages ? navigator.languages.join(', ') : 'Unknown',
                    browser: browserInfo.browser,
                    os: browserInfo.os,
                    screen: `${screen.width}x${screen.height}`,
                    viewport: `${window.innerWidth}x${window.innerHeight}`,
                    userAgent: navigator.userAgent,
                    referrer: document.referrer || 'Direct',
                    url: window.location.href,
                    cookieEnabled: navigator.cookieEnabled,
                    onlineStatus: navigator.onLine,
                    platform: navigator.platform,
                    redirectUrl: decodeURIComponent(this.redirectUrl)
                };
            }

            getBrowserInfo() {
                const ua = navigator.userAgent;
                let browser = 'Unknown';
                let os = 'Unknown';

                // Detect browser
                if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
                else if (ua.includes('Firefox')) browser = 'Firefox';
                else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
                else if (ua.includes('Edg')) browser = 'Edge';
                else if (ua.includes('Opera')) browser = 'Opera';

                // Detect OS
                if (ua.includes('Windows')) os = 'Windows';
                else if (ua.includes('Mac')) os = 'macOS';
                else if (ua.includes('Linux')) os = 'Linux';
                else if (ua.includes('Android')) os = 'Android';
                else if (ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';

                return { browser, os };
            }

            async getLocationInfo() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    if (!response.ok) {
                        throw new Error('Location service unavailable');
                    }
                    const data = await response.json();
                    
                    return {
                        ip: data.ip || 'Unknown',
                        city: data.city || 'Unknown',
                        region: data.region || 'Unknown',
                        country: data.country_name || 'Unknown',
                        countryCode: data.country_code || 'XX',
                        timezone: data.timezone || 'Unknown',
                        isp: data.org || 'Unknown',
                        latitude: data.latitude || 0,
                        longitude: data.longitude || 0
                    };
                } catch (error) {
                    console.warn('Could not fetch location info:', error);
                    return {
                        ip: 'Unknown', city: 'Unknown', region: 'Unknown',
                        country: 'Unknown', countryCode: 'XX', timezone: 'Unknown',
                        isp: 'Unknown', latitude: 0, longitude: 0
                    };
                }
            }

            async sendTrackingData() {
                try {
                    // In a real application, this would send data to your server
                    // For this demo, we'll use localStorage to simulate server storage
                    const existingData = JSON.parse(localStorage.getItem('visitorTrackingData') || '{"visitors":[],"trackingLinks":[]}');
                    
                    // Find the tracking link and increment clicks
                    const linkIndex = existingData.trackingLinks.findIndex(link => link.id === this.trackingId);
                    if (linkIndex !== -1) {
                        existingData.trackingLinks[linkIndex].clicks++;
                        this.visitorData.linkName = existingData.trackingLinks[linkIndex].name;
                        this.visitorData.linkType = existingData.trackingLinks[linkIndex].type;
                    }
                    
                    // Add visitor data
                    existingData.visitors.unshift(this.visitorData);
                    existingData.lastUpdated = Date.now();
                    
                    // Save updated data
                    localStorage.setItem('visitorTrackingData', JSON.stringify(existingData));
                    
                    console.log('âœ… Tracking data saved successfully');
                    
                    // In production, you would make an API call like:
                    /*
                    const response = await fetch('/api/track', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.visitorData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send tracking data');
                    }
                    */
                    
                } catch (error) {
                    console.error('Failed to send tracking data:', error);
                    // Continue with redirect even if tracking fails
                }
            }

            performRedirect() {
                const redirectUrl = decodeURIComponent(this.redirectUrl);
                
                // Show manual redirect option
                document.getElementById('manual-link').href = redirectUrl;
                
                // Auto redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 2000);
                
                // Show manual option after 3 seconds if redirect didn't work
                setTimeout(() => {
                    document.getElementById('manual-redirect').style.display = 'block';
                }, 3000);
            }

            showError(message) {
                document.querySelector('.spinner').style.display = 'none';
                document.querySelector('.redirect-text').textContent = 'Redirect Failed';
                document.querySelector('.redirect-info').textContent = 'Unable to process your request';
                document.getElementById('error-message').textContent = message;
                document.getElementById('error-container').style.display = 'block';
            }
        }

        // Initialize tracking redirect when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new TrackingRedirect();
        });

        // Handle page visibility for accurate tracking
        let startTime = Date.now();
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                const timeSpent = Date.now() - startTime;
                console.log(`Time spent on redirect page: ${timeSpent}ms`);
            }
        });

        // Prevent back button issues
        window.addEventListener('beforeunload', (e) => {
            // Optional: Add any cleanup or final tracking
        });
    </script>
</body>
</html>
